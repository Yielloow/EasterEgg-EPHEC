<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Challenge des Codes - Challenge IT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              neonBlue: "#38bdf8",
              neonPink: "#e879f9",
              cardBg: "#050816",
            },
          },
        },
      };
    </script>

    <style>
      body {
        background: radial-gradient(circle at top left, #0ea5e911, transparent 50%),
          radial-gradient(circle at bottom right, #a855f711, transparent 50%),
          #020617;
        color: #e5e7eb;
      }
      .grid-bg {
        background-image:
          linear-gradient(rgba(148, 163, 184, 0.08) 1px, transparent 1px),
          linear-gradient(90deg, rgba(148, 163, 184, 0.08) 1px, transparent 1px);
        background-size: 40px 40px;
      }
      .glass {
        background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 45%),
          radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.12), transparent 45%),
          linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96));
        backdrop-filter: blur(16px);
      }
      @keyframes shake {
        10%, 90% { transform: translateX(-1px); }
        20%, 80% { transform: translateX(2px); }
        30%, 50%, 70% { transform: translateX(-4px); }
        40%, 60% { transform: translateX(4px); }
      }
      .shake {
        animation: shake 0.4s;
      }
    </style>
  </head>
  <body class="min-h-screen grid-bg flex flex-col relative">
    <!-- Bouton Admin cach√© (en bas √† droite) -->
    <button
      id="hidden-admin-btn"
      class="fixed bottom-4 right-4 w-10 h-10 rounded-full bg-gradient-to-r from-neonBlue to-neonPink opacity-0 hover:opacity-40 transition shadow-lg text-xs text-white font-semibold"
      title=""
      onclick="window.location.href='admin.html'"
    >
      A
    </button>

    <!-- Main -->
    <main class="flex-1 flex items-center justify-center px-4 pb-10">
      <div class="w-full max-w-6xl mx-auto flex flex-col md:flex-row gap-6 items-start">
        <!-- Colonne gauche : leaderboard -->
        <div class="w-full md:w-1/3 glass rounded-3xl shadow-2xl px-6 py-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span>üèÜ</span> Classement
          </h2>
          <p class="text-xs text-slate-400 mb-3">
            Classement des √©tudiants bas√© sur le total de points cumul√©s.
          </p>
          <div id="leaderboard" class="space-y-3 text-sm">
            <p class="text-slate-400">Chargement du classement‚Ä¶</p>
          </div>
        </div>

        <!-- Colonne centre : Challenge des codes -->
        <div class="w-full md:w-1/3 flex justify-center">
          <div
            id="card"
            class="relative w-full glass rounded-3xl shadow-2xl px-6 py-7 md:px-8 md:py-8 transition-transform"
          >
            <!-- Croix dans le panel -->
            <a
              href="index.html"
              class="absolute top-4 right-4 w-7 h-7 flex items-center justify-center rounded-full bg-slate-900/70 border border-slate-700 text-slate-300 text-sm hover:text-white hover:border-slate-500 transition"
              aria-label="Retour au site principal"
            >
              √ó
            </a>

            <h1
              class="text-2xl md:text-3xl font-bold mb-4 text-center leading-normal bg-gradient-to-r from-neonBlue to-neonPink bg-clip-text text-transparent"
            >
              Challenge des codes
            </h1>
            <p class="text-center text-slate-300 mb-6 text-sm">
              Entrez votre code pour valider un Easter Egg.
            </p>

            <!-- message erreur / panneau stop -->
            <div
              id="error-box"
              class="hidden mb-4 rounded-2xl bg-red-900/70 border border-red-500/80 px-4 py-3 text-xs flex items-center gap-3 text-red-100"
            >
              <span class="text-2xl">üõë</span>
              <span id="error-text">Code invalide.</span>
            </div>

            <!-- Formulaire -->
            <form id="code-form" class="mb-4 space-y-4">
              <div>
                <label for="code" class="block mb-2 text-xs text-slate-300 uppercase tracking-wide">
                  Entrer un code
                </label>
                <div class="flex flex-col gap-3">
                  <input
                    id="code"
                    type="text"
                    autocomplete="off"
                    placeholder="Entrez votre code..."
                    class="w-full rounded-full bg-slate-900/70 border border-slate-700 px-5 py-3 text-sm outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                  />
                  <button
                    type="submit"
                    class="w-full rounded-full px-6 py-3 bg-gradient-to-r from-neonBlue to-neonPink text-sm font-semibold text-white shadow-lg hover:opacity-90 transition"
                  >
                    Valider
                  </button>
                </div>
              </div>

              <!-- Champs √©tudiant (affich√©s apr√®s code valide) -->
              <div id="student-fields" class="grid grid-cols-1 gap-3 hidden">
                <input
                  id="student-name"
                  type="text"
                  placeholder="Nom"
                  class="rounded-full bg-slate-900/70 border border-slate-700 px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                />
                <input
                  id="student-class"
                  type="text"
                  placeholder="Classe"
                  class="rounded-full bg-slate-900/70 border border-slate-700 px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                />
                <input
                  id="student-matricule"
                  type="text"
                  placeholder="Matricule"
                  class="rounded-full bg-slate-900/70 border border-slate-700 px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-neonBlue focus:border-transparent"
                />
              </div>
            </form>
          </div>
        </div>

        <!-- Colonne droite : indices -->
        <div class="w-full md:w-1/3 glass rounded-3xl shadow-2xl px-6 py-6">
          <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
            <span>üß©</span> Indices des codes restants
          </h2>
          <p class="text-xs text-slate-400 mb-3">
            Indices pour les Easter Eggs qui peuvent encore √™tre d√©couverts.
          </p>
          <div id="hints-list" class="space-y-3 text-sm">
            <p class="text-slate-400">Chargement des indices‚Ä¶</p>
          </div>
        </div>
      </div>
    </main>

    <!-- Script Firebase / Firestore -->
    <script type="module">
      import { db } from "./firebase-config.js";
      import {
        collection,
        query,
        where,
        getDocs,
        addDoc,
        updateDoc,
        doc,
        increment,
        serverTimestamp,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      const form = document.getElementById("code-form");
      const studentFields = document.getElementById("student-fields");
      const codeInput = document.getElementById("code");
      const nameInput = document.getElementById("student-name");
      const classInput = document.getElementById("student-class");
      const matriculeInput = document.getElementById("student-matricule");
      const errorBox = document.getElementById("error-box");
      const errorText = document.getElementById("error-text");
      const card = document.getElementById("card");
      const leaderboardEl = document.getElementById("leaderboard");
      const hiddenAdminBtn = document.getElementById("hidden-admin-btn");
      const hintsListEl = document.getElementById("hints-list");

      let currentEggDoc = null;
      let step = 1; // 1 = v√©rifier code, 2 = infos √©tudiant

      // Bouton admin cach√© -> page de login admin
      hiddenAdminBtn.addEventListener("click", () => {
        window.location.href = "admin.html";
      });

      function showError(msg) {
        errorText.textContent = msg;
        errorBox.classList.remove("hidden");
        card.classList.remove("shake");
        void card.offsetWidth;
        card.classList.add("shake");
      }

      function clearError() {
        errorBox.classList.add("hidden");
        card.classList.remove("shake");
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearError();

        if (step === 1) {
          const code = codeInput.value.trim();
          if (!code) {
            showError("Merci d'entrer un code.");
            return;
          }

          try {
            const eggsRef = collection(db, "eggs");
            const q = query(eggsRef, where("code", "==", code));
            const snap = await getDocs(q);

            if (snap.empty) {
              showError("üõë Code invalide. V√©rifie le code et r√©essaie.");
              return;
            }

            const docSnap = snap.docs[0];
            const egg = docSnap.data();

            if (egg.usedCount >= egg.maxUses) {
              showError("üõë Ce code a d√©j√† √©t√© utilis√© le nombre maximal de fois.");
              return;
            }

            currentEggDoc = { id: docSnap.id, ...egg };
            step = 2;
            studentFields.classList.remove("hidden");
            alert("Code valide ! Entre maintenant ton nom, ta classe et ton matricule.");
          } catch (err) {
            console.error(err);
            showError("üõë Erreur lors de la v√©rification du code.");
          }
        } else if (step === 2 && currentEggDoc) {
          const studentName = nameInput.value.trim();
          const studentClass = classInput.value.trim();
          const matricule = matriculeInput.value.trim();

          if (!studentName || !studentClass || !matricule) {
            showError("üõë Merci de compl√©ter toutes les informations.");
            return;
          }

          try {
            await addDoc(collection(db, "discoveries"), {
              eggId: currentEggDoc.id,
              studentName,
              studentClass,
              matricule,
              points: currentEggDoc.points ?? 10,
              createdAt: serverTimestamp(),
            });

            const eggRef = doc(db, "eggs", currentEggDoc.id);
            await updateDoc(eggRef, {
              usedCount: increment(1),
            });

            alert("Bravo ! Ta d√©couverte a √©t√© enregistr√©e üéâ");

            form.reset();
            studentFields.classList.add("hidden");
            currentEggDoc = null;
            step = 1;
            clearError();

            // recharger les indices (au cas o√π un code vient d'√™tre √©puis√©)
            loadHints();
          } catch (err) {
            console.error(err);
            showError("üõë Erreur lors de l'enregistrement de ta d√©couverte.");
          }
        }
      });

      // ===== Leaderboard : classement cumul√© par √©tudiant =====
      function initLeaderboard() {
        const discoveriesRef = collection(db, "discoveries");

        onSnapshot(discoveriesRef, (snap) => {
          if (snap.empty) {
            leaderboardEl.innerHTML =
              '<p class="text-slate-400 text-sm">Aucune d√©couverte pour le moment.</p>';
            return;
          }

          const stats = new Map();

          snap.forEach((d) => {
            const data = d.data();
            const key = data.matricule || data.studentName || "inconnu";
            if (!stats.has(key)) {
              stats.set(key, {
                matricule: data.matricule || "",
                name: data.studentName || "Anonyme",
                cls: data.studentClass || "",
                points: 0,
                count: 0,
              });
            }
            const entry = stats.get(key);
            entry.points += data.points ?? 0;
            entry.count += 1;
          });

          const arr = Array.from(stats.values());
          arr.sort((a, b) => b.points - a.points);

          const top = arr.slice(0, 10);
          let html = "";
          let rank = 1;
          top.forEach((p) => {
            html += `
              <div class="flex items-center justify-between rounded-2xl bg-slate-900/80 border border-slate-800 px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="w-7 h-7 rounded-full bg-slate-800 flex items-center justify-center text-xs font-semibold text-slate-100">
                    ${rank++}
                  </div>
                  <div>
                    <p class="font-semibold">${p.name}</p>
                    <p class="text-xs text-slate-400">${p.cls} ${p.matricule ? "‚Ä¢ " + p.matricule : ""}</p>
                  </div>
                </div>
                <div class="text-right text-xs">
                  <p class="font-semibold text-neonBlue">${p.points} pts</p>
                  <p class="text-slate-400">${p.count} code(s)</p>
                </div>
              </div>
            `;
          });

          leaderboardEl.innerHTML = html;
        });
      }

      // ===== Indices des codes restants =====
      async function loadHints() {
        try {
          const eggsRef = collection(db, "eggs");
          const snap = await getDocs(eggsRef);

          if (snap.empty) {
            hintsListEl.innerHTML =
              '<p class="text-slate-400 text-sm">Aucun Easter Egg configur√© pour le moment.</p>';
            return;
          }

          const items = [];
          snap.forEach((d) => {
            const egg = d.data();
            const remaining = (egg.maxUses ?? 0) - (egg.usedCount ?? 0);
            if (remaining > 0) {
              items.push({
                cours: egg.cours || "Cours / bloc inconnu",
                indice: egg.indice || "Pas d'indice communiqu√©.",
                teacher: egg.teacherName || "Professeur anonyme",
                remaining,
              });
            }
          });

          if (items.length === 0) {
            hintsListEl.innerHTML =
              '<p class="text-slate-400 text-sm">Tous les Easter Eggs ont √©t√© d√©couverts pour le moment.</p>';
            return;
          }

          let html = "";
          items.forEach((item) => {
            html += `
              <div class="rounded-2xl bg-slate-900/80 border border-slate-800 px-4 py-3">
                <p class="text-xs font-semibold text-neonBlue mb-1">${item.cours}</p>
                <p class="text-sm text-slate-200 mb-1">${item.indice}</p>
                <p class="text-xs text-slate-400 mb-1">Propos√© par ${item.teacher}</p>
                <p class="text-xs text-slate-500">Encore ${item.remaining} validation(s) possible(s).</p>
              </div>
            `;
          });

          hintsListEl.innerHTML = html;
        } catch (err) {
          console.error(err);
          hintsListEl.innerHTML =
            '<p class="text-red-400 text-sm">Erreur lors du chargement des indices.</p>';
        }
      }

      initLeaderboard();
      loadHints();
    </script>
  </body>
</html>

